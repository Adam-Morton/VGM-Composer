<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project</title>
<link rel="stylesheet" href="/style.css" />
</head>
<style>
  .custom-audio-player {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: 1rem 0;
    background: #333;
    padding: 0.75rem 0rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgb(0 0 0 / 0.6);
    color: #eee;
    user-select: none;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .custom-audio-player button {
    background: #444;
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
    color: #eee;
  }
  .custom-audio-player button:hover {
    background: #66aaff;
    color: #fff;
  }

  .custom-audio-player button svg {
    width: 22px;
    height: 22px;
    fill: currentColor;
  }

  input[type=range] {
    -webkit-appearance: none;
    width: 130px;
    height: 6px;
    background: #444;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  input[type=range]:hover {
    background: #66aaff;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    background: #66aaff;
    cursor: pointer;
    border-radius: 50%;
    border: none;
    transition: background-color 0.3s ease;
  }
  input[type=range]:hover::-webkit-slider-thumb {
    background: #3399ff;
  }
  input[type=range]::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: #66aaff;
    cursor: pointer;
    border-radius: 50%;
    border: none;
    transition: background-color 0.3s ease;
  }
  input[type=range]:hover::-moz-range-thumb {
    background: #3399ff;
  }

  #volume {
    width: 100px;
  }

  .timestamp {
    font-family: monospace;
    font-size: 0.85rem;
    color: #bbb;
    min-width: 85px;
    text-align: center;
  }
</style>
<body>

<header id="site-header"></header>

<section class="hero" id="hero"></section>
<section id="project-details">
  <p style="text-align:center;">Loading project...</p>
</section>

<div id="site-footer"></div>

<script>
// --- Helpers ---
async function loadHTML(id, url) {
  const res = await fetch(url);
  document.getElementById(id).innerHTML = await res.text();
}

async function fetchJSON(url) {
  const res = await fetch(url);
  return await res.json();
}

// Format seconds as mm:ss
function formatTime(seconds) {
  if (isNaN(seconds)) return '0:00';
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

// --- Custom Audio Player Setup ---
function setupCustomAudioPlayer(audioPath) {
  const container = document.createElement('div');
  container.className = 'custom-audio-player';

  // SVG icons for play/pause and mute/unmute
  const playIcon = `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M8 5v14l11-7z"/>
    </svg>`;
  const pauseIcon = `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6 19h4V5H6zm8-14v14h4V5z"/>
    </svg>`;
  const volumeOnIcon = `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 9v6h4l5 5V4L7 9H3z"/>
      <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/>
    </svg>`;
  const volumeMuteIcon = `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z" fill="none"/>
      <path d="M19 12c0 3.87-3.13 7-7 7v2c5.52 0 10-4.48 10-10h-2zM3 9v6h4l5 5V4L7 9H3z" fill="none"/>
      <line x1="19" y1="5" x2="5" y2="19" stroke="currentColor" stroke-width="2"/>
    </svg>`;

  container.innerHTML = `
    <button id="play-pause" aria-label="Play/Pause">${playIcon}</button>
    <input type="range" id="progress" value="0" min="0" max="100" step="1" aria-label="Progress Bar" />
    <span class="timestamp" id="timestamp">0:00 / 0:00</span>
    <button id="mute-unmute" aria-label="Mute/Unmute">${volumeOnIcon}</button>
    <input type="range" id="volume" value="100" min="0" max="100" step="1" aria-label="Volume Control" />
    <audio id="audio" src="${audioPath}" loop preload="metadata"></audio>
  `;

  const audio = container.querySelector('#audio');
  const playPauseBtn = container.querySelector('#play-pause');
  const progress = container.querySelector('#progress');
  const volume = container.querySelector('#volume');
  const muteUnmuteBtn = container.querySelector('#mute-unmute');
  const timestamp = container.querySelector('#timestamp');

  function updatePlayButton() {
    if (audio.paused) {
      playPauseBtn.innerHTML = playIcon;
    } else {
      playPauseBtn.innerHTML = pauseIcon;
    }
  }

  function updateMuteButton() {
    if (audio.muted || audio.volume === 0) {
      muteUnmuteBtn.innerHTML = volumeMuteIcon;
    } else {
      muteUnmuteBtn.innerHTML = volumeOnIcon;
    }
  }

  // Play / Pause toggle
  playPauseBtn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
    updatePlayButton();
  });

  // Update progress bar and timestamp as audio plays
  audio.addEventListener('timeupdate', () => {
    if (audio.duration) {
      progress.value = (audio.currentTime / audio.duration) * 100;
      timestamp.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
    }
  });

  // When metadata loaded, update timestamp total duration
  audio.addEventListener('loadedmetadata', () => {
    timestamp.textContent = `${formatTime(0)} / ${formatTime(audio.duration)}`;
  });

  // Seek audio when progress bar changes
  progress.addEventListener('input', () => {
    if (audio.duration) {
      audio.currentTime = (progress.value / 100) * audio.duration;
    }
  });

  // Volume control
  volume.addEventListener('input', () => {
    audio.volume = volume.value / 100;
    audio.muted = audio.volume === 0;
    updateMuteButton();
  });

  // Mute / Unmute toggle
  muteUnmuteBtn.addEventListener('click', () => {
    audio.muted = !audio.muted;
    if (audio.muted) {
      volume.value = 0;
    } else {
      volume.value = audio.volume * 100 || 100;
    }
    updateMuteButton();
  });

  // Update play button if audio ends (though loop is forced)
  audio.addEventListener('ended', () => {
    updatePlayButton();
  });

  // Initialize buttons state
  updatePlayButton();
  updateMuteButton();

  return container;
}

// --- Render Functions ---
function renderHero(project, projectSlug) {
  const hero = document.getElementById('hero');
  hero.innerHTML = `
    <div style="text-align:center; margin:1rem 0;">
      <h1>${project.title}</h1>
      ${project.description ? `<p>${project.description}</p>` : ''}
      ${
        (() => {
          const ctaLink = project.cta?.link || project.link;
          const ctaText = project.cta?.text || 'Visit Project';
          return ctaLink
            ? `<a href="${ctaLink}" class="btn">${ctaText}</a>`
            : '';
        })()
      }
    </div>
  `;
}

function renderProjectDetails(project, projectSlug) {
  const container = document.getElementById('project-details');
  let html = '';

  const folder = `../${projectSlug}/`;
  const mainImage = project.image || `${folder}cover.png`;
  html += `<img src="${mainImage}" alt="${project.title}" style="max-width:600px; width:100%; display:block; margin: 1rem auto;">`;

  // Placeholder div for the custom audio player
  html += `<div id="custom-audio-container" style="text-align:center;"></div>`;

  // Extended details
  if (project.details) {
    const d = project.details;
    html += '<div style="text-align:center; margin-top:1.5rem;">';
    if (d.summary) html += `<p>${d.summary}</p>`;
    if (d.tech) html += `<p><strong>Tech:</strong> ${d.tech.join(', ')}</p>`;
    if (d.date) html += `<p><strong>Date:</strong> ${d.date}</p>`;
    if (d.role) html += `<p><strong>Role:</strong> ${d.role}</p>`;
    if (d.client) html += `<p><strong>Client:</strong> ${d.client}</p>`;
    html += '</div>';
  }

  if (project.gallery && project.gallery.length > 0) {
    html += '<div class="project-gallery">';
    project.gallery.forEach(img => {
      html += `<img src="../${img}" alt="${project.title}">`;
    });
    html += '</div>';
  }

  if (project.video) {
    html += `
      <div class="responsive-video">
        <iframe src="${project.video}" frameborder="0" allowfullscreen></iframe>
      </div>
    `;
  }

  // Back to Home button moved here
  html += `<div style="text-align:center; margin-top:2rem;">
             <a href="/" class="btn">Back to Home</a>
           </div>`;

  if (project.testimonials && project.testimonials.length > 0) {
    html += '<div style="margin-top:2rem; text-align:center;">';
    html += '<h2>Testimonials</h2>';
    project.testimonials.forEach(t => {
      html += `<p><strong>${t.author} // ${t.role}</strong></p>
               <p><em>"${t.text}"</em></p>`;
    });
    html += '</div>';
  }

  container.innerHTML = html;

  // Insert custom audio player
  const audioPath = project.audio || `${folder}audio.wav`;
  const audioContainer = document.getElementById('custom-audio-container');
  const customPlayer = setupCustomAudioPlayer(audioPath);
  audioContainer.appendChild(customPlayer);
}

// --- Main ---
async function init() {
  await loadHTML('site-header', '/header.html');
  await loadHTML('site-footer', '/footer.html');

  const params = new URLSearchParams(window.location.search);
  const projectSlug = params.get('name') || window.location.pathname.split('/').filter(Boolean).pop();

  const data = await fetchJSON('/data.json');
  const project = data.projects.find(p => (p.slug || p.title.toLowerCase().replace(/\s+/g,'-')) === projectSlug);

  if (!project) {
    document.getElementById('project-details').innerHTML =
      '<p style="text-align:center;">Project not found. <a href="/" class="btn">Back to home</a></p>';
    return;
  }

  renderHero(project, projectSlug);
  renderProjectDetails(project, projectSlug);
}

init();
</script>

</body>
</html>
